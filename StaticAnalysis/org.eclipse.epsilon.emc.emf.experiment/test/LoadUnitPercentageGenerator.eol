var allContents = m.allContents();

var size = allContents.size();

var counter = new Map;

var oppositeRefs = new Set;

for(a in allContents)
{
	var count = counter.get(a.type());
	var featureCount = 1;
	for(feature in a.type().eStructuralFeatures)
	{
		if(a.eGet(feature).isDefined() and feature.derived = false)
		{
			var opposite = feature.opposite;
			if(opposite.isDefined())
			{
				if(oppositeRefs.excludes(opposite))
				{
					oppositeRefs.add(opposite);
					featureCount = featureCount + 1;
				}
			}
			else
			{
				featureCount = featureCount + 1;
			}
			
		}
	}

	if(count.isDefined())
	{
		count = count + featureCount;
		counter.put(a.type(), count);
	}
	else
	{
		counter.put(a.type(), 1);
	}
}

var sum = 0;

for(k in counter.keySet())
{
	k.name.print();
	": ".print();
	var val = counter.get(k);
	sum = sum + val;
	val.println();
}



sum.println();

size.println();

var eolQueryString = "var size = 0;\n";

for(clazz in getPercent(counter, sum, 20))
{
	eolQueryString = eolQueryString + "var " + clazz.name.firstToLowerCase() + " = " + clazz.name + ".all.first;\n";
	for(feature in clazz.eStructuralFeatures)
	{
		eolQueryString = eolQueryString + "size = size + " + clazz.name + ".all." + feature.name + ".size();\n";
	}
	eolQueryString = eolQueryString + "size = size + " + clazz.name + ".all.size();\n";
	
	clazz.name.print();
	": ".print();
	var val = counter.get(clazz);
	val.println();
}

eolQueryString = eolQueryString + "size.println();\n";
eolQueryString.println();

@cached
operation getNumberOfContents(a: Any)
{
	var sum = a.eContents.size();
	for(content in a.eContents)
	{
		sum = sum + getNumberOfContents(content);
	}
	return sum;
}


operation getPercent(counter: Map, size: Integer, percent : Integer)
{
	var result = new Set;
	var number = size*percent/100;
	var sum = 0;
	for(k in counter.keySet())
	{
		var value = counter.get(k);
		if(value < number)
		{
			if(value + sum <= number and value + sum < number * 1.15)
			{
				sum = sum + value;
				result.add(k);
			}
		}
		if(sum > number)
		{
			break;
		}
	}
	sum.errln();
	return result;
}